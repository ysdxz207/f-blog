<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>自动发布</title>
    <#include "/public/public.html" />
    <script src="/public_static/js/lib/laydate/laydate.js"></script>
</head>
<body>
<div class="container">
    <div class="col-md-12">
        <form class="col-md-6">
            <input type="hidden" name="data" value="true"/>
            <div class="form-group">
                <h3>发布设置</h3>
                <br/>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <span class="input-group-addon"><span
                            class="glyphicon glyphicon-user"></span></span>
                    <input class="form-control" name="jjusername" placeholder="用户名"/>
                </div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <span class="input-group-addon"><span
                            class="glyphicon glyphicon-lock"></span></span>
                    <input class="form-control" name="jjpassword" type="password" placeholder="密码"/>
                </div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <span class="input-group-addon"><span
                            class="glyphicon glyphicon-time"></span></span>
                    <input class="form-control" readonly name="jjpubtime" placeholder="发布时间"/>
                </div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <span class="input-group-addon"><span
                            class="glyphicon glyphicon-link"></span></span>
                    <input class="form-control" name="jjpubpage" placeholder="发布页面链接"/>
                </div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <img id="img_captcha" style="cursor: pointer" height="25" width="80" alt="点击获取验证码"/>
                    <span>点击验证码可刷新</span>
                    <input class="form-control" name="captcha" placeholder="验证码"/>
                </div>
            </div>
            <div class="form-group pull-right">
                <div class="input-group">
                    <button type="button" class="btn btn-success" id="btn_confirm_autopublish">确认设定</button>
                </div>
            </div>
        </form>
    </div>
</div>
</body>

<!--<script src="/public_static/js/sdate.js"></script>-->
<script src="/public_static/js/bootstrap-alert.js"></script>

<script>
    $(function () {
        laydate.render({
            theme: '#393D49',
            elem: 'input[name=jjpubtime]',
            type: 'datetime',
//            value: sdate.getNowDate(1, 'yyyy-MM-dd') + ' 01:59:59',
//            min: new Date().formatDate("yyyy-MM-dd HH:mm:ss")
        });

        $('#btn_confirm_autopublish').on('click', function () {
            checkConfigAndRun();
        });

        $('#img_captcha').on('click', function () {
            getCaptcha();
        });
        getCaptcha();

        function checkConfigAndRun() {
            var btnConfirm = $('#btn_confirm_autopublish');
            salert('在设置自动发布前将进行帐号密码以及系统检测，若提示设置失败，则需要检查配置。', '提示', null, null, function(ok) {
                if (ok) {
                    btnConfirm.attr('disabled', true);
                    checkConfig();
                }
            });


        }


        function getCaptcha() {
            var btnConfirm = $('#btn_confirm_autopublish');
            var btnConfirmText = btnConfirm.text();
            var imgCaptcha = $('#img_captcha');

            $.ajax({
                url: "/autopublish/captcha",
                method: "GET",
                dataType: "json",
                success: function (result) {
                    if (result.statusCode == 200) {

                        imgCaptcha.attr('src', 'data:image/gif;base64,' + result.message)
                    } else {
                        salert("[获取验证码失败]：" + result.message)
                    }
                    btnConfirm.text(btnConfirmText);
                    btnConfirm.attr('disabled', false);
                },
                error: function (a, b) {
                    salert("服务器内部错误：" + JSON.stringify(a) + "\n" + b);
                }
            });
        }

        function checkConfig() {
            var btnConfirm = $('#btn_confirm_autopublish');
            var btnConfirmText = btnConfirm.text();
            btnConfirm.text('检测中...');
            btnConfirm.attr('disabled', true);
            $.ajax({
                url: "/autopublish/check",
                data: $('form').serialize(),
                method: "GET",
                dataType: "json",
                success: function (result) {
                    if (result.statusCode == 200) {
                        runAutoPublish();
                    } else {
                        salert("[未能通过检测]：" + result.message)
                    }
                    btnConfirm.text(btnConfirmText);
                    btnConfirm.attr('disabled', false);
                },
                error: function (a, b) {
                    salert("服务器内部错误：" + JSON.stringify(a) + "\n" + b);
                }
            });
        }
        
        function runAutoPublish() {
            var btnConfirm = $('#btn_confirm_autopublish');
            var btnConfirmText = btnConfirm.text();
            btnConfirm.text('启动中...');
            btnConfirm.attr('disabled', true);
            $.ajax({
                url: "/autopublish",
                data: $('form').serialize(),
                method: "GET",
                dataType: "json",
                success: function (result) {
                    if (result.statusCode == 200) {
                        salert("设置成功！！！");
                    } else {
                        salert("[未能启动自动发布]：" + result.message)
                    }
                    btnConfirm.text(btnConfirmText);
                    btnConfirm.attr('disabled', false);
                },
                error: function (a, b) {
                    salert("服务器内部错误：" + a + "\n" + b);
                }
            });
        }
    })

</script>
</html>